pipeline {
    agent any;
    parameters {
        string(defaultValue: "", description: 'Docker Hub User', name: 'DockerHubUser')
        string(defaultValue: "", description: 'Docker Hub Token', name: 'DockerHubToken')
    }
    stages {
        stage('Computing Changes') {
            steps {
                sh  """
                    echo $PATH
                    echo ""
                    echo ""
                    echo ""
                    git fetch --tag
                    echo "Tags:"
                    git tag
                    echo "### Changed Files ###"
                    echo "production_pointer is in:"
                    git rev-list -n 1 production_pointer
                    git diff --name-only production_pointer \${GIT_COMMIT}
                    echo "### Generating Dependency Graph ###"
                    ./generates_deps
                    """
                
            }
        }
        stage('Impacted Unit Test') {
            steps {
                echo 'Testing..'
                sh  """
                    echo ""
                    echo ""
                    echo ""
                    echo "### TESTING ###"
                    ./test_impacted production_pointer \${GIT_COMMIT}
                    """
            }
        }
        stage('Pushing Impacted Images') {
            steps {
                echo 'Pushing Imagess ..'
                sh  """
                    echo ""
                    echo ""
                    echo ""
                    echo "### Push Impacted ###"
                    docker login --username ${params.DockerHubUser} -p  ${params.DockerHubToken} 
                    ./push_impacted production_pointer \${GIT_COMMIT}
                    """
            }
        }
        stage('Deploy') {
            steps {
                echo 'Deploying....'
            }
          }
        }

    post {
        always {
            echo 'One way or another, I have finished'
        }
        success {
            archiveArtifacts artifacts: '*.png', fingerprint: true
            echo 'I succeeeded!'
        }
        unstable {
            echo 'I am unstable :/'
        }
        failure {
            echo 'I failed :('
        }
        changed {
            echo 'Things were different before...'
        }   
    }
}

